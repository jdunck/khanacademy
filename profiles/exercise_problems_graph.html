{% block graph %}

{% if not problem_list %}
    <div class="graph-notification">{{student_nickname|escape}} needs to do a few more problems in {{exercise_display_name|escape}} before we can start displaying this graph.</div>
{% endif %}

<script>
var chart;

function exercise_url(point) {
    return "/exercises?exid={{ exid|escapejs }}&read_only=1&problem_number=" + point.x + (point.exercise_non_summative ? "&exid_non_summative=" + point.exercise_non_summative : ""); 
}

			$(document).ready(function() {
				chart = new Highcharts.Chart({
					chart: {
						renderTo: 'highchart',
						defaultSeriesType: 'column'
					},
                    credits: {
                        enabled: false
                    },
                    plotOptions: {
                        scatter: {
                            marker: {
                                states: {
                                    hover: {
                                        fillColor: 'transparent',
                                        lineColor: 'transparent'
                                    }
                                }
                            }
                        },
                        column: {
                            cursor: 'pointer',
                            minPointLength: 10
                        },
                        series: {
                            point: {
                                events: {
                                    click: function() {
                                        window.location = exercise_url(this);
                                    }
                                }
                            },
                            events: {
                                legendItemClick: function() { return false; }
                            }
                        }
                    },
					title: {
                        text: '',
						x: -20 //center
					},
					subtitle: {
                        text: "{{ exercise_display_name|escapejs }}",
						x: -20
					},
					xAxis: {
						title: {
                            text: '{{ x_axis_label|escapejs }}'
						},
                        tickInterval: 1,
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}]
					},
					yAxis: {
						title: {
							text: 'Time Used (seconds)'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}]
					},
					tooltip: {
						formatter: function() {
                            if (this.point.fVideo) {
                                if (!this.point.desc) return false;
                                return '<strong>Related Videos</strong> (' + this.point.time_watched + ')<br/><br/>' + this.point.desc;
                            }
                            else {
                                return '<b><a style="color:blue;" ' + 
                                        'href="' + exercise_url(this.point) + '"' +
                                        '>Problem ' + this.point.x + 
                                        '</a> - ' + (this.point.correct ? "Correct" : "Incorrect") +
                                        '</b><br/>' +
                                        'Seconds used: ' + this.point.time_taken + '<br/>' +
                                        (this.point.exercise_non_summative ? 'From exercise: ' + this.point.exercise_non_summative_display_name + '<br/>' : '') +
                                        '<br/><em>Click the graph to view this problem</em>.';
                            }
						}
					},
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'top',
                        floating: true,
                        backgroundColor: 'white',
                        shadow: true,
                        x: 0,
                        y: 5,
                        symbolWidth: 0,
                        itemHoverStyle: {
                            cursor: 'default',
                            color: '#3E576F'
                        },
                        labelFormatter: function() {
                            return "Last Ten: {{ percent_last_ten_correct|escapejs }}% correct<br/>Current Streak: {{ streak|escapejs }}<br/>Longest Streak: {{ longest_streak|escapejs }}<br/>";
                        }
                    },
                    series: [
                            {
                                data:[
                                {% for problem in problem_list %}
                                {
                                    correct: {% if problem.correct %}true{% else %}false{% endif %},
                                    time_taken: {{ problem.time_taken }},
                                    {% if problem.exercise_non_summative %}
                                        exercise_non_summative_display_name: '{{ problem.exercise_non_summative_display_name|escapejs }}',
                                        exercise_non_summative: '{{ problem.exercise_non_summative|escapejs }}',
                                    {% endif %}
                                    name: '{{ user_exercise.name|escapejs }}',
                                    x: {{ forloop.counter }} + {{ x_offset }},
                                    y: {{ problem.time_taken }},
                                    color: '{% if problem.correct %}#ADD8E6{% else %}red{% endif %}'
                                }
                                {% if not forloop.last %},{% endif %}
                                {% endfor %}
                                ]
                            },
                            {
                                type: 'scatter',
                                showInLegend: false,
                                data:[
                                {% for problem in problem_list %}
                                {
                                    fVideo: true,
                                    x: {{ forloop.counter }} + {{ x_offset }},
                                    {% if problem.video_point %}
                                        y: {{ problem.time_taken }},
                                        desc: '{{ problem.video_titles_html|escapejs }}',
                                        time_watched: '{{ problem.video_time|escapejs }}',
                                        marker: { symbol: 'url(/images/camera-small-chart.png)'}
                                    {% else %}
                                        y: 0,
                                        enabled: false
                                    {% endif %}
                                }
                                {% if not forloop.last %},{% endif %}
                                {% endfor %}
                                ]
                            }]
				});
			});
</script>

<div id="highchart-container" class="{% if not problem_list %}empty-chart{% endif %}">
    <div id="highchart"></div>
</div>

{% endblock graph %}

